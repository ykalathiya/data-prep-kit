
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../../data-processing-lib/doc/advanced-transform-tutorial/">
      
      
      
      <link rel="icon" href="../../../data-processing-lib/doc/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.30">
    
    
      
        <title>KFP Pipeline - Data Prep Kit</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../assets/stylesheets/badge.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#simplest-transform-pipeline-tutorial" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Data Prep Kit" class="md-header__button md-logo" aria-label="Data Prep Kit" data-md-component="logo">
      
  <img src="../../../data-processing-lib/doc/logo-ibm.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Data Prep Kit
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              KFP Pipeline
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/IBM/data-prep-kit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../data-processing-lib/doc/overview/" class="md-tabs__link">
        
  
    
  
  Overview

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../data-processing-lib/doc/transform-tutorials.md" class="md-tabs__link">
          
  
  Tutorials

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Data Prep Kit" class="md-nav__button md-logo" aria-label="Data Prep Kit" data-md-component="logo">
      
  <img src="../../../data-processing-lib/doc/logo-ibm.png" alt="logo">

    </a>
    Data Prep Kit
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/IBM/data-prep-kit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data-processing-lib/doc/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data-processing-lib/doc/transform-tutorials.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    None
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data-processing-lib/doc/simplest-transform-tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simple
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../data-processing-lib/doc/advanced-transform-tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    KFP Pipeline
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    KFP Pipeline
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      📝 Table of Contents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing pipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#imports-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Imports definition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#components-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Components definition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#input-parameters-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Input parameters definition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Pipeline definition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Additional configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compiling-a-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Compiling a pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-a-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying a pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#executing-pipeline-and-watching-execution-results" class="md-nav__link">
    <span class="md-ellipsis">
      Executing pipeline and watching execution results
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clean-up-the-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      Clean up the cluster
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      📝 Table of Contents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing pipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#imports-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Imports definition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#components-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Components definition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#input-parameters-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Input parameters definition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Pipeline definition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Additional configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compiling-a-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Compiling a pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-a-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying a pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#executing-pipeline-and-watching-execution-results" class="md-nav__link">
    <span class="md-ellipsis">
      Executing pipeline and watching execution results
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clean-up-the-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      Clean up the cluster
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="simplest-transform-pipeline-tutorial">Simplest Transform pipeline tutorial</h1>
<p>In this example, we implement a pipeline to automate execution of the simple 
<a href="../../../data-processing-lib/doc/simplest-transform-tutorial/">noop transform</a></p>
<p>In this tutorial, we will show the following:</p>
<ul>
<li>How to write the <code>noop</code> transform automation pipeline, leveraging <a href="../../kfp_ray_components/">KFP components</a>.</li>
<li>How to compile a pipeline and deploy it to KFP</li>
<li>How to execute pipeline and view execution results</li>
</ul>
<p>Note: the project and the explanation below are based on <a href="https://www.kubeflow.org/docs/components/pipelines/v1/">KFPv1</a></p>
<h2 id="table-of-contents">📝 Table of Contents</h2>
<ul>
<li><a href="#implementing">Implementing pipeline</a></li>
<li><a href="#imports">Imports definition</a> </li>
<li><a href="#components">Components definition</a></li>
<li><a href="#inputs">Input parameters definition</a></li>
<li><a href="#pipeline">Pipeline definition</a></li>
<li><a href="#add_config">Additional configuration</a></li>
<li><a href="#compilation">Compiling a pipeline</a></li>
<li><a href="#deploying">Deploying a pipeline</a></li>
<li><a href="#execution">Executing pipeline and watching execution results</a></li>
<li><a href="#cleanup&quot;">Clean up the cluster</a></li>
</ul>
<h2 id="implementing-pipeline">Implementing pipeline <a name = "implementing"></a></h2>
<p><a href="../../transforms/universal/noop/kfp_ray/v1/noop_wf.py">Overall implementation</a> roughly contains 5 major sections:</p>
<ul>
<li>Imports</li>
<li>Components definition - definition of the main steps of our pipeline</li>
<li>Input parameters definition </li>
<li>Pipeline wiring - definition of the sequence of invocation (with parameter passing) of participating components</li>
<li>Additional configuration</li>
</ul>
<h3 id="imports-definition">Imports definition <a name = "imports"></a></h3>
<pre><code class="language-python">import kfp.compiler as compiler
import kfp.components as comp
import kfp.dsl as dsl
from kfp_support.workflow_support.runtime_utils import (
  ONE_HOUR_SEC,
  ONE_WEEK_SEC,
  ComponentUtils,
)
from kubernetes import client as k8s_client
</code></pre>
<h3 id="components-definition">Components definition <a name = "components"></a></h3>
<p>Our pipeline includes 4 steps - compute execution parameters, create Ray cluster, submit and watch Ray job, clean up 
Ray cluster. For each step we have to define a component that will execute them:</p>
<pre><code class="language-python">    # components
    base_kfp_image = &quot;quay.io/dataprep1/data-prep-kit/kfp-data-processing:0.0.2&quot;
    # compute execution parameters. Here different transforms might need different implementations. As
    # a result, instead of creating a component we are creating it in place here.
    compute_exec_params_op = comp.func_to_container_op(
      func=ComponentUtils.default_compute_execution_params, base_image=base_kfp_image
    )
    # create Ray cluster
    create_ray_op = comp.load_component_from_file(&quot;../../../kfp_ray_components/createRayComponent.yaml&quot;)
    # execute job
    execute_ray_jobs_op = comp.load_component_from_file(&quot;../../../kfp_ray_components/executeRayJobComponent.yaml&quot;)
    # clean up Ray
    cleanup_ray_op = comp.load_component_from_file(&quot;../../../kfp_ray_components/cleanupRayComponent.yaml&quot;)
    # Task name is part of the pipeline name, the ray cluster name and the job name in DMF.
    TASK_NAME: str = &quot;noop&quot;
</code></pre>
<p>Note: here we are using shared components described in this <a href="../../kfp_ray_components/">document</a> for <code>create_ray_op</code>, 
<code>execute_ray_jobs_op</code> and <code>cleanup_ray_op</code>,  while <code>compute_exec_params_op</code> component is built inline, because it might
differ significantly. For "simple" pipeline cases we can use the 
<a href="../kfp_support_lib/src/kfp_support/workflow_support/runtime_utils/remote_jobs_utils.py">default implementation</a>,
while, for example for exact dedup, we are using a very <a href="../../transforms/universal/ededup/kfp_ray/v2/src/ededup_compute_execution_params.py">specialized one</a>.</p>
<h3 id="input-parameters-definition">Input parameters definition <a name = "inputs"></a></h3>
<p>The input parameters section defines all the parameters required for the pipeline execution:</p>
<pre><code class="language-python">    # Ray cluster
    ray_name: str = &quot;noop-kfp-ray&quot;,  # name of Ray cluster
    ray_head_options: str = '{&quot;cpu&quot;: 1, &quot;memory&quot;: 4, \
                 &quot;image&quot;: &quot;' + task_image + '&quot; }',
    ray_worker_options: str = '{&quot;replicas&quot;: 2, &quot;max_replicas&quot;: 2, &quot;min_replicas&quot;: 2, &quot;cpu&quot;: 2, &quot;memory&quot;: 4, \
                &quot;image&quot;: &quot;' + task_image + '&quot; }',
    server_url: str = &quot;http://kuberay-apiserver-service.kuberay.svc.cluster.local:8888&quot;,
    # data access
    data_s3_config: str = &quot;{'input_folder': 'test/noop/input/', 'output_folder': 'test/noop/output/'}&quot;,
    data_s3_access_secret: str = &quot;s3-secret&quot;,
    data_max_files: int = -1,
    data_num_samples: int = -1,
    # orchestrator
    actor_options: str = &quot;{'num_cpus': 0.8}&quot;,
    pipeline_id: str = &quot;pipeline_id&quot;,
    code_location: str = &quot;{'github': 'github', 'commit_hash': '12345', 'path': 'path'}&quot;,
    # noop parameters
    noop_sleep_sec: int = 10,
    # additional parameters
    additional_params: str = '{&quot;wait_interval&quot;: 2, &quot;wait_cluster_ready_tmout&quot;: 400, &quot;wait_cluster_up_tmout&quot;: 300, &quot;wait_job_ready_tmout&quot;: 400, &quot;wait_print_tmout&quot;: 30, &quot;http_retries&quot;: 5}',
</code></pre>
<p>The parameters used here are as follows:</p>
<ul>
<li>ray_name: name of the Ray cluster</li>
<li>ray_head_options: head node options, containing the following:</li>
<li>cpu - number of cpus</li>
<li>memory - memory</li>
<li>image - image to use</li>
<li>image_pull_secret - image pull secret</li>
<li>ray_worker_options: worker node options (we here are using only 1 worker pool), containing the following:</li>
<li>replicas - number of replicas to create</li>
<li>max_replicas - max number of replicas</li>
<li>min_replicas - min number of replicas</li>
<li>cpu - number of cpus</li>
<li>memory - memory</li>
<li>image - image to use</li>
<li>image_pull_secret - image pull secret</li>
<li>server_url - server url</li>
<li>additional_params: additional (support) parameters, containing the following:</li>
<li>wait_interval - wait interval for API server, sec</li>
<li>wait_cluster_ready_tmout - time to wait for cluster ready, sec</li>
<li>wait_cluster_up_tmout - time to wait for cluster up, sec</li>
<li>wait_job_ready_tmout - time to wait for job ready, sec</li>
<li>wait_print_tmout - time between prints, sec</li>
<li>http_retries - http retries for API server calls</li>
<li>data_s3_access_secret - s3 access secret</li>
<li>data_s3_config - s3 configuration</li>
<li>data_max_files - max files to process</li>
<li>data_num_samples - num samples to process</li>
<li>actor_options - actor options</li>
<li>pipeline_id - pipeline id</li>
<li>code_location - code location</li>
<li>noop_sleep_sec - noop sleep time</li>
</ul>
<p><strong>Note</strong> that here we are specifying initial values for all parameters that will be propagated to the workflow UI
(see below)</p>
<p><strong>Note</strong> Parameters are defining both S3 and Lakehouse configuration, but only one at a time can be used.</p>
<h3 id="pipeline-definition">Pipeline definition <a name = "pipeline"></a></h3>
<p>Now, when all components and input parameters are defined, we can implement pipeline wiring defining sequence of 
component execution and parameters submitted to every component. </p>
<pre><code class="language-python">    # create clean_up task
    clean_up_task = cleanup_ray_op(ray_name=ray_name, run_id=dsl.RUN_ID_PLACEHOLDER, server_url=server_url)
    ComponentUtils.add_settings_to_component(clean_up_task, 60)
    # pipeline definition
    with dsl.ExitHandler(clean_up_task):
      # compute execution params
      compute_exec_params = compute_exec_params_op(
        worker_options=ray_worker_options,
        actor_options=actor_options,
      )
      ComponentUtils.add_settings_to_component(compute_exec_params, ONE_HOUR_SEC * 2)
      # start Ray cluster
      ray_cluster = create_ray_op(
        ray_name=ray_name,
        run_id=dsl.RUN_ID_PLACEHOLDER,
        ray_head_options=ray_head_options,
        ray_worker_options=ray_worker_options,
        server_url=server_url,
        additional_params=additional_params,
      )
      ComponentUtils.add_settings_to_component(ray_cluster, ONE_HOUR_SEC * 2)
      ray_cluster.after(compute_exec_params)
      # Execute job
      execute_job = execute_ray_jobs_op(
        ray_name=ray_name,
        run_id=dsl.RUN_ID_PLACEHOLDER,
        additional_params=additional_params,
        # note that the parameters below are specific for NOOP transform
        exec_params={
          &quot;data_s3_config&quot;: data_s3_config,
          &quot;data_max_files&quot;: data_max_files,
          &quot;data_num_samples&quot;: data_num_samples,
          &quot;num_workers&quot;: compute_exec_params.output,
          &quot;worker_options&quot;: actor_options,
          &quot;pipeline_id&quot;: pipeline_id,
          &quot;job_id&quot;: dsl.RUN_ID_PLACEHOLDER,
          &quot;code_location&quot;: code_location,
          &quot;noop_sleep_sec&quot;: noop_sleep_sec,
        },
        exec_script_name=EXEC_SCRIPT_NAME,
        server_url=server_url,
      )
      ComponentUtils.add_settings_to_component(execute_job, ONE_WEEK_SEC)
      ComponentUtils.set_s3_env_vars_to_component(execute_job, data_s3_access_secret)
      execute_job.after(ray_cluster)
</code></pre>
<p>Here we first create <code>cleanup_task</code> and the use it as an 
<a href="https://kubeflow-pipelines.readthedocs.io/en/stable/source/dsl.html#kfp.dsl.ExitHandler">exit handler</a> which will be 
invoked either the steps into it succeeded or failed.</p>
<p>Then we create each individual component passing it required parameters and specify execution sequence, for example
(<code>ray_cluster.after(compute_exec_params)</code>).</p>
<h3 id="additional-configuration">Additional configuration <a name = "add_config"></a></h3>
<p>The final thing that we need to do is set some pipeline global configuration:</p>
<pre><code class="language-python">    # Configure the pipeline level to one week (in seconds)
    dsl.get_pipeline_conf().set_timeout(ONE_WEEK_SEC)
</code></pre>
<h2 id="compiling-a-pipeline">Compiling a pipeline <a name = "compilation"></a></h2>
<p>To compile pipeline execute <code>make workflow-build</code> command in the same directory where your pipeline is. </p>
<h2 id="deploying-a-pipeline">Deploying a pipeline <a name = "deploying"></a></h2>
<p>Prepare local Kind or external Kubernetes cluster as described in <a href="../setup/">Set Up a cluster</a></p>
<p>Once the cluster is up, go to the kfp endpoint (<code>localhost:8080/kfp/</code> for Kind cluster, the end point of the external existing 
cluster depends on the KFP end-point configuration), which will bring up 
KFP UI, see below:</p>
<p><img alt="KFP UI" src="../kfp_ui.png" /></p>
<p>Click on the <code>Upload pipeline</code> link and follow instructions on the screen to upload your file (<code>noop_wf.yaml</code>) and
name pipeline noop. Once this is done, you should see something as follows:</p>
<p><img alt="noop pipeline" src="../noop_pipeline.png" /></p>
<h2 id="executing-pipeline-and-watching-execution-results">Executing pipeline and watching execution results <a name = "execution"></a></h2>
<p>Before we can run the pipeline we need to create required secrets (one for image loading in case of secured 
image registry and one for S3 access). As KFP is deployed in <code>kubeflow</code> namespace, workflow execution will happen
there as well, which means that secrets have to be created there as well.</p>
<p>When the MinIO Object Store, deployed as part of KFP, is used, its access secret is deployed as part of the cluster preparation, 
see <a href="https://github.com/ykalathiya/data-prep-kit/blob/dev/scripts/k8s-setup/s3_secret.yaml">s3_secret.yaml</a>. 
Creation a secret to pull images from a private repository described <a href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/">here</a></p>
<p>Once this is done we can execute the workflow. </p>
<p>On the pipeline page (above) click on the <code>create run</code> button. You will see the list of the parameters, that you
can redefine or use the default values that we specified above. After that,
go to the bottom of the page and click the <code>start</code> button</p>
<p>This will start workflow execution. Once it completes you will see something similar to below </p>
<p><img alt="execution result" src="../execution_result.png" /></p>
<p>Note that the log (on the left) has the complete execution log.</p>
<p>Additionally, the log is saved to S3 (location is denoted but the last line in the log)</p>
<h2 id="clean-up-the-cluster">Clean up the cluster <a name = "cleanup"></a></h2>
<p>The cluster clean up is described at <a href="./setup#cleanup">Clean up the cluster</a></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../../../assets/javascripts/badge.js" async></script>
      
    
  </body>
</html>